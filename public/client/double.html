<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Réservation Mission Double</title>
<link rel="stylesheet" href="../css/theme_client.css">
</head>

<body>

<h2>Mission Double (1h30)</h2>

<form id="form-double">

    <!-- DATE -->
    <label>Date :</label>
    <input type="date" id="date" required />

    <!-- CODE POSTAL -->
    <label>Code postal :</label>
    <input type="text" id="cp" required />
    <div id="suggestions-cp" class="hidden"></div>

    <!-- COMMUNE -->
    <label>Commune :</label>
    <input type="text" id="commune" required />

    <!-- 30 MIN EN PLUS -->
    <label>Ajouter 30 min ?</label>
    <input type="checkbox" id="extra30" />

    <!-- CRÉNEAUX -->
    <div id="wrapper-creneaux" class="hidden">
        <h3>Créneaux disponibles</h3>
        <div id="creneaux-optimises"></div>
        <div id="creneaux-libres"></div>
    </div>

    <h3>Total : <span id="prix-total">0 €</span></h3>

    <button type="button" id="btn-payer">Payer</button>
</form>

<!-- STRIPE -->
<script src="https://js.stripe.com/v3/"></script>

<!-- TES SCRIPTS -->
<script src="../communes_client.js"></script>
<script type="module" src="../js/firebase_client.js"></script>
<script src="./slot.js"></script>

<script>

// =====================================================
// CALCUL PRIX MISSION DOUBLE
// =====================================================

function calculerPrixDouble() {

    let prixBase = 79;  // Exemple mission double (ajuste si nécessaire)
    let extra = document.getElementById("extra30").checked ? 15 : 0;

    let cp = document.getElementById("cp").value;

    // distance via ton tableau des communes
    let commune = communes.find(c => String(c.cp) === String(cp));
    let distance = commune ? commune.distance : 0;

    let prixDeplacement = distance * 0.5;

    // bonus/malus optimisation
    let optimisation = window.creneauOptimisation || 0;

    let prixTotal = prixBase + extra + prixDeplacement + optimisation;

    document.getElementById("prix-total").textContent =
        prixTotal.toFixed(2) + " €";

    return prixTotal;
}


// =====================================================
// QUAND L'UTILISATEUR CHOISIT UN CRÉNEAU
// =====================================================

window.onCreneauSelected = function (bonus) {
    window.creneauOptimisation = bonus;
    calculerPrixDouble();
};

document.getElementById("extra30").onchange = calculerPrixDouble;
document.getElementById("cp").oninput = calculerPrixDouble;


// =====================================================
// BOUTON PAYER
// =====================================================

document.getElementById("btn-payer").addEventListener("click", () => {
    const prixTotal = calculerPrixDouble();
    lancerPaiement(prixTotal, "Mission Double");
});


// =====================================================
// INTÉGRATION STRIPE
// =====================================================

async function lancerPaiement(prixTotal, description) {

    if (!prixTotal || prixTotal <= 0) {
        alert("Le prix n’a pas pu être calculé.");
        return;
    }

    try {
        const response = await fetch("/.netlify/functions/create-checkout-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                amount: prixTotal,
                description: description
            })
        });

        const data = await response.json();

        const stripe = Stripe("pk_test_51SXNhuQBlPkBPQsBNpCjAXfbaeCd8pWKYy2qYiN0tUZQFMqkoRPydrtsI6PSLFjpecdYFp0zDKTMCQxeeVFGq1YX00kTjbvtsw"); // ← TA CLÉ PUBLIQUE STRIPE

        stripe.redirectToCheckout({ sessionId: data.sessionId });
    }
    catch (e) {
        console.error(e);
        alert("Erreur lors du lancement du paiement.");
    }
}

</script>

</body>
</html>



