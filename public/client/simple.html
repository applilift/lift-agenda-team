<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Réservation Simple</title>
<link rel="stylesheet" href="../styles.css">
</head>

<body>

<h2>Réservation Simple</h2>

<form id="form-simple">

    <!-- DATE -->
    <label>Date :</label>
    <input type="date" id="date" required>

    <!-- CODE POSTAL -->
    <label>Code postal :</label>
    <input type="text" id="cp" required>
    <div id="suggestions-cp" class="hidden"></div>

    <!-- COMMUNE -->
    <label>Commune :</label>
    <input type="text" id="commune" required>

    <!-- DEMI-HEURE SUP -->
    <label>Ajouter 30 min ?</label>
    <input type="checkbox" id="extra30">

    <!-- CRÉNEAUX -->
    <div id="wrapper-creneaux" class="hidden">
        <h3>Choisissez votre créneau</h3>
        <div id="creneaux-optimises"></div>
        <div id="creneaux-libres"></div>
    </div>

    <h3>Total : <span id="prix-total">0 €</span></h3>

    <button type="button" id="btn-payer">Payer</button>

</form>

<script src="https://js.stripe.com/v3/"></script>

<script src="../communes_client.js"></script>
<script src="../slot.js"></script>

<script>

// =====================================================
// CALCUL DU PRIX FINAL
// =====================================================

function calculerPrix() {
    let prixBase = 49;                  // exemple
    let extra = document.getElementById("extra30").checked ? 10 : 0;
    let cp = document.getElementById("cp").value;

    // distance via ton fichier communes_client.js
    let commune = communes.find(c => String(c.cp) === String(cp));
    let distance = commune ? commune.distance : 0;
    let prixDeplacement = distance * 0.5;

    // créneau optimisé ?
    let optimisation = window.creneauOptimisation || 0;

    let prixTotal = prixBase + extra + prixDeplacement + optimisation;

    document.getElementById("prix-total").textContent = prixTotal.toFixed(2) + " €";

    return prixTotal;
}

// =====================================================
// QUAND L’UTILISATEUR CHOISIT UN CRÉNEAU
// =====================================================

window.onCreneauSelected = function (bonus) {
    window.creneauOptimisation = bonus;
    calculerPrix();
};

// recalcul quand besoin (CP, date, extra 30 min…)
document.getElementById("extra30").onchange = calculerPrix;
document.getElementById("cp").oninput = calculerPrix;


// =====================================================
// BOUTON PAYER
// =====================================================

document.getElementById("btn-payer").addEventListener("click", () => {
    const prixTotal = calculerPrix();
    lancerPaiement(prixTotal, "Service Simple");
});


// =====================================================
// INTÉGRATION STRIPE (Étape 1 ✔︎)
// =====================================================

async function lancerPaiement(prixTotal, description) {

    if (!prixTotal || prixTotal <= 0) {
        alert("Le prix n’a pas pu être calculé.");
        return;
    }

    const res = await fetch("/.netlify/functions/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            amount: prixTotal,
            description: description
        })
    });

    const data = await res.json();

    const stripe = Stripe("pk_test_51SXNhuQBlPkBPQsBNpCjAXfbaeCd8pWKYy2qYiN0tUZQFMqkoRPydrtsI6PSLFjpecdYFp0zDKTMCQxeeVFGq1YX00kTjbvtsw"); // ← ta clé publique
    stripe.redirectToCheckout({ sessionId: data.sessionId });
}

</script>

</body>
</html>


