<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√©servation One Shot</title>

  <link rel="stylesheet" href="../css/theme_client.css" />

  <style>
    .slots-wrapper.hidden { display: none; }
    #slots { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .slot-btn { padding:10px 14px; border-radius:6px; border:1px solid #ccc; background:#eee; cursor:pointer; }
    .slot-btn.selected { background:#c3e8ff; border-color:#1e90ff; font-weight:600; }
    .input-error { border-color:#d9534f !important; background:#ffe5e5 !important; }
  </style>
</head>

<body>
<div class="page-container">
  <h1>R√©servation One Shot</h1>
  <hr />

  <form id="form-one-shot" novalidate>

    <label>Date souhait√©e :</label>
    <input type="date" id="date" required />

    <label>Code postal :</label>
    <input type="text" id="cp" maxlength="4" required />

    <label>Commune :</label>
    <input type="text" id="commune" required />
    <div id="cpcom-status" style="font-size:13px;color:#666;margin-top:4px;"></div>

    <label>Adresse compl√®te :</label>
    <input type="text" id="adresse" placeholder="Rue + num√©ro" required />

    <label>T√©l√©phone :</label>
    <input type="tel" id="telephone" required />

    <label>E-mail :</label>
    <input type="email" id="email" required />

    <label>Note :</label>
    <textarea id="note" rows="2"></textarea>

    <input type="hidden" id="slot" />

    <hr />
    <h2>Cr√©neaux disponibles</h2>

    <div id="slots-wrapper" class="slots-wrapper hidden">
      <p id="msg-slot"></p>
      <div id="slots"></div>
    </div>

    <hr />
    <button type="button" id="btn-reserver" class="btn-primary">
      R√©server ce cr√©neau
    </button>
  </form>
</div>

<!-- ========================= FIREBASE ========================= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const app = initializeApp({
    apiKey: "AIzaSyC5Rly--5aw3VSEuhRcyZxzD5fg1JJowbE",
    authDomain: "lift-agenda-app.firebaseapp.com",
    databaseURL: "https://lift-agenda-app-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "lift-agenda-app"
  });

  window.db = getDatabase(app);
  window.firebaseRef = ref;
  window.firebasePush = push;
</script>

<!-- ========================= AUTO-COMPL√âTION CP ‚Üí COMMUNE ========================= -->
<script>
const cpInput = document.getElementById("cp");
const comInput = document.getElementById("commune");
const statusEl = document.getElementById("cpcom-status");

let timer;
cpInput.addEventListener("input", () => {
  const cp = cpInput.value.trim();
  comInput.value = "";
  statusEl.textContent = "";

  if (cp.length !== 4) return;

  clearTimeout(timer);
  timer = setTimeout(async () => {
    statusEl.textContent = "Recherche de la commune‚Ä¶";

    try {
      const res = await fetch(
        `https://secure.geonames.org/postalCodeSearchJSON?postalcode=${cp}&country=BE&maxRows=1&username=demo`
      );
      const data = await res.json();

      if (!data.postalCodes?.length) {
        statusEl.textContent = "Code postal inconnu";
        return;
      }

      comInput.value = data.postalCodes[0].placeName;
      statusEl.textContent = "Commune d√©tect√©e automatiquement ‚úîÔ∏è";
    } catch {
      statusEl.textContent = "Erreur de recherche";
    }
  }, 300);
});
</script>

<!-- ========================= MOTEUR DE CR√âNEAUX ========================= -->
<script src="js/slot.js"></script>

<!-- ========================= SUBMIT ========================= -->
<script>
document.getElementById("btn-reserver").onclick = async () => {
  const date = dateEl.value;
  const cp = cpInput.value;
  const commune = comInput.value;
  const adresse = adresseEl.value;
  const slot = document.getElementById("slot").value;

  if (!date || !cp || !commune || !adresse || !slot) {
    alert("Merci de compl√©ter tous les champs.");
    return;
  }

  const fullAdresse = `${adresse}, ${cp} ${commune}, Belgique`;

  // üîê G√©ocodage backend
  let geo;
  try {
    const res = await fetch(`/api/geocode?text=${encodeURIComponent(fullAdresse)}`);
    geo = await res.json();
  } catch {
    alert("Erreur de g√©ocodage.");
    return;
  }

  if (!geo?.lat || !geo?.lng) {
    alert("Adresse introuvable.");
    return;
  }

  const [start, end] = slot.split("‚Äì").map(s => s.trim());

  const reservation = {
    type: "LFT",
    subType: "ONE_SHOT",
    date,
    start,
    end,
    adresse: fullAdresse,
    cp,
    commune,
    coords: geo,
    phone: telephone.value,
    email: email.value,
    note: note.value || "",
    createdAt: new Date().toISOString()
  };

  try {
    await window.firebasePush(
      window.firebaseRef(window.db, "reservations"),
      reservation
    );
    alert("R√©servation enregistr√©e !");
  } catch (e) {
    console.error(e);
    alert("Erreur d'enregistrement.");
  }
};
</script>

</body>
</html>



